name: üè≠ Go-like-Rust Transpiler (Industrial Loop v2.1)

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 0 * * *"   # Îß§Ïùº ÏûêÏ†ï UTC
  workflow_dispatch:

permissions:
  contents: write

env:
  BUILD_DIR: build/transpiled
  LEDGER_DIR: proof
  SNAPSHOT_TAG: snapshot-transpile-${{ github.run_number }}

jobs:
  transpile:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------
      - name: üß≠ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------
      - name: ‚öôÔ∏è Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"

      # ----------------------------
      - name: üßæ Ensure Go module
        run: |
          if [ ! -f go.mod ]; then
            echo "Initializing Go module (gcrust)"
            go mod init gcrust
          fi
          go mod tidy

      # ----------------------------
      - name: üß© Prepare directories
        run: |
          mkdir -p "$BUILD_DIR" "$LEDGER_DIR"

      # ----------------------------
      - name: ü¶Ä Transpile Rust-like sources
        run: |
          echo "=== Go-like-Rust Transpile Run ($(date -u)) ==="
          for f in $(find examples -name '*.rs'); do
            echo "‚û°Ô∏è Transpiling $f"
            go run main.go transpile "$f"
          done
          find examples -name '*_gen.go' -exec cp {} "$BUILD_DIR" \;

      # ----------------------------
      - name: üß™ Run transpiled outputs
        run: |
          for g in $(find "$BUILD_DIR" -name '*_gen.go'); do
            echo "‚ñ∂Ô∏è Running $g"
            go run "$g" || echo "‚ö†Ô∏è $g failed"
          done

      # ----------------------------
      - name: üîí Generate ProofLedger
        run: |
          mkdir -p "$LEDGER_DIR"
          cd "$BUILD_DIR"
          if ls *_gen.go 1>/dev/null 2>&1; then
            sha256sum *_gen.go > "../$LEDGER_DIR/SHA256SUMS.txt"
          else
            echo "No generated Go files found." > "../$LEDGER_DIR/SHA256SUMS.txt"
          fi
          cd "../$LEDGER_DIR"
          echo "GO-LIKE-RUST TRANSPILER PROOFLEDGER ‚Äî $(date -u)" > ProofLedger.txt
          echo "Generated Files: $(ls ../$BUILD_DIR | wc -l)" >> ProofLedger.txt
          echo "UTC Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> ProofLedger.txt
          cat SHA256SUMS.txt >> ProofLedger.txt
          cd ..

      # ----------------------------
      - name: üßæ Commit & push ledger + generated code
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$BUILD_DIR"/* "$LEDGER_DIR"/*
          git commit -m "üè≠ Auto-transpiled Go-like-Rust snapshot" || echo "No changes"
          git push origin main || echo "‚úÖ No push needed"

      # ----------------------------
      - name: üåÄ Create snapshot release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release delete "$SNAPSHOT_TAG" --yes || true
          gh release create "$SNAPSHOT_TAG" "$BUILD_DIR"/*.go "$LEDGER_DIR"/ProofLedger.txt \
            --title "Go-like-Rust Transpile Snapshot" \
            --notes "Automated transpile and verification proof ‚Äî $(date -u)"

      # ----------------------------
      - name: üì¶ Upload artifact for CI logs
        uses: actions/upload-artifact@v4
        with:
          name: transpile-proof-${{ github.run_number }}
          path: |
            $BUILD_DIR/
            $LEDGER_DIR/
