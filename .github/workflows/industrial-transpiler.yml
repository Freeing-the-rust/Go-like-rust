name: üè≠ Go-like-Rust Transpiler (Industrial Loop v2.2 ‚Äî Resilient Dual Loop Edition)

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 0 * * *"   # Îß§Ïùº ÏûêÏ†ï UTC
  workflow_dispatch:

permissions:
  contents: write

env:
  BUILD_DIR: build/transpiled
  LEDGER_DIR: proof
  SNAPSHOT_TAG: snapshot-transpile-${{ github.run_number }}
  BACKUP_REPO: r3c-foundation/r3c-backup
  DATE_UTC: ${{ github.run_id }}

jobs:
  transpile:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      - name: üß≠ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------
      - name: ‚öôÔ∏è Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"

      # -----------------------------
      - name: üßæ Ensure Go module
        run: |
          if [ ! -f go.mod ]; then
            echo "Initializing Go module (gcrust)"
            go mod init gcrust
          fi
          go mod tidy

      # -----------------------------
      - name: üß© Prepare directories
        run: |
          mkdir -p "$GITHUB_WORKSPACE/$BUILD_DIR" "$GITHUB_WORKSPACE/$LEDGER_DIR"

      # -----------------------------
      - name: ü¶Ä Transpile Rust-like sources
        run: |
          echo "=== Go-like-Rust Transpile Run ($(date -u)) ==="
          for f in $(find examples -name '*.rs'); do
            echo "‚û°Ô∏è  Transpiling $f"
            go run main.go transpile "$f"
          done
          find examples -name '*_gen.go' -exec cp {} "$GITHUB_WORKSPACE/$BUILD_DIR" \;

      # -----------------------------
      - name: üß™ Run transpiled outputs
        run: |
          for g in $(find "$GITHUB_WORKSPACE/$BUILD_DIR" -name '*_gen.go'); do
            echo "‚ñ∂Ô∏è Running $g"
            go run "$g" || echo "‚ö†Ô∏è $g failed"
          done

      # -----------------------------
      - name: üîí Generate ProofLedger
        run: |
          mkdir -p "$GITHUB_WORKSPACE/$LEDGER_DIR"
          cd "$GITHUB_WORKSPACE/$BUILD_DIR"

          if ls *_gen.go 1>/dev/null 2>&1; then
            sha256sum *_gen.go > "$GITHUB_WORKSPACE/$LEDGER_DIR/SHA256SUMS.txt"
          else
            echo "No generated Go files found." > "$GITHUB_WORKSPACE/$LEDGER_DIR/SHA256SUMS.txt"
          fi

          cd "$GITHUB_WORKSPACE/$LEDGER_DIR"
          echo "GO-LIKE-RUST TRANSPILER PROOFLEDGER ‚Äî $(date -u)" > ProofLedger.txt
          echo "Generated Files: $(ls $GITHUB_WORKSPACE/$BUILD_DIR | wc -l)" >> ProofLedger.txt
          echo "UTC Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> ProofLedger.txt
          cat SHA256SUMS.txt >> ProofLedger.txt

      # -----------------------------
      - name: üîç Compare with previous ledger (ProofLedgerDiff)
        run: |
          mkdir -p diff
          PREV=$(ls proof_history/ProofLedger-*.txt 2>/dev/null | tail -n 1 || true)
          if [ -n "$PREV" ]; then
            echo "üîç Comparing with $PREV"
            diff -u "$PREV" "$GITHUB_WORKSPACE/$LEDGER_DIR/ProofLedger.txt" > diff/ProofLedgerDiff.txt || true
          else
            echo "No previous ProofLedger found" > diff/ProofLedgerDiff.txt
          fi
          cp "$GITHUB_WORKSPACE/$LEDGER_DIR/ProofLedger.txt" "proof_history/ProofLedger-$(date -u +%Y%m%d-%H%M).txt" || true

      # -----------------------------
      - name: üßæ Commit & Push ledger + generated code
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$BUILD_DIR"/* "$LEDGER_DIR"/* diff/* || true
          git commit -m "üè≠ v2.2 Transpile Loop ‚Äî ProofLedger + Diff" || echo "No changes"
          git push origin main || echo "‚úÖ No push needed"

      # -----------------------------
      - name: üåÄ Create snapshot release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release delete "$SNAPSHOT_TAG" --yes || true
          gh release create "$SNAPSHOT_TAG" "$BUILD_DIR"/*.go "$LEDGER_DIR"/ProofLedger.txt diff/ProofLedgerDiff.txt \
            --title "Go-like-Rust Transpile Snapshot v2.2" \
            --notes "Automated transpile + hash verification loop ‚Äî $(date -u)"

      # -----------------------------
      - name: üåê Mirror to backup repository
        if: github.ref == 'refs/heads/main'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üîÅ Syncing to backup repository: $BACKUP_REPO"
          git remote add backup "https://github.com/$BACKUP_REPO.git"
          git push backup main || echo "‚ö†Ô∏è Backup sync failed"

      # -----------------------------
      - name: üì¶ Upload artifacts (proof, diff)
        uses: actions/upload-artifact@v4
        with:
          name: transpile-proof-v2.2-${{ github.run_number }}
          path: |
            $BUILD_DIR/
            $LEDGER_DIR/
            diff/
