name: ðŸ›ï¸ Go-like-Rust Transpiler (v3.3 â€” 3OS Independent Releases + Stats)

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

env:
  BUILD_DIR: build/transpiled
  LEDGER_DIR: proof

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      # ---------------------------------------------------------
      - name: ðŸ§­ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"

      - name: âš™ï¸ Prepare Env
        shell: bash
        run: |
          mkdir -p "$BUILD_DIR" "$LEDGER_DIR"
          echo "System: ${{ matrix.os }}"
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then sudo apt-get update -y && sudo apt-get install -y gnuplot; fi

      # ---------------------------------------------------------
      - name: ðŸ—ï¸ Build Go-like-Rust (OS-specific)
        id: build
        shell: bash
        run: |
          echo "ðŸ—ï¸ Building for ${{ matrix.os }}"
          go mod tidy
          GOOS=$(echo "${{ matrix.os }}" | cut -d'-' -f1)
          EXT=""
          [ "$GOOS" = "windows" ] && EXT=".exe"
          OUTPUT="$BUILD_DIR/gcrust-${GOOS}${EXT}"
          if go build -o "$OUTPUT" main.go; then
            echo "âœ… Build Success"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Build Failed"
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

      # ---------------------------------------------------------
      - name: ðŸ§¾ Record contributor ledger
        run: |
          AUTHOR="${{ github.actor }}"
          EMAIL=$(git log -1 --pretty=format:'%ae')
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          echo "[$TIMESTAMP] $AUTHOR <$EMAIL> â€” Built on ${{ matrix.os }}" >> "$LEDGER_DIR/contributor-ledger.txt"

      # ---------------------------------------------------------
      - name: ðŸ“ˆ Contributor stats (Linux only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          echo "ðŸ‘¥ Stats generated â€” $(date -u)" > "$LEDGER_DIR/contributor-scores.txt"
          rm -f "$LEDGER_DIR/contributor-rank-data.txt"
          for email in $(git log --format='%ae' | sort | uniq); do
            chars=$(git log --author="$email" --pretty=tformat: --numstat | awk '{add+=$1} END {print add}')
            name=$(git log --author="$email" --pretty="%aN" | head -n 1)
            printf "%-25s â€” %10d chars\n" "$name <$email>" "$chars" >> "$LEDGER_DIR/contributor-scores.txt"
            echo "$name $chars" >> "$LEDGER_DIR/contributor-rank-data.txt"
          done
          if [ -s contributor-rank-data.txt ]; then
            sort -k2 -nr contributor-rank-data.txt > rank-sorted.txt
            echo "set terminal svg size 900,400; \
                  set output 'contributor-rank.svg'; \
                  set title 'Go-like-Rust Contributor Ranking'; \
                  set style data histograms; \
                  set style fill solid; \
                  plot 'rank-sorted.txt' using 2:xtic(1) title 'Char Count'" | gnuplot
          fi

      # ---------------------------------------------------------
      - name: ðŸŒ€ Create OS-specific release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          GOOS=$(echo "${{ matrix.os }}" | cut -d'-' -f1)
          TAG="snapshot-${GOOS}-v3.3-${{ github.run_number }}"
          TITLE="Go-like-Rust v3.3 â€” ${GOOS^} Build Snapshot"
          NOTES="Independent release for $GOOS â€” built at $(date -u)"
          echo "ðŸŒ€ Creating $TITLE"
          gh release delete "$TAG" --yes || true
          gh release create "$TAG" \
            "$BUILD_DIR/gcrust-${GOOS}"* \
            "$LEDGER_DIR/contributor-ledger.txt" \
            $([ "$GOOS" = "linux" ] && echo "$LEDGER_DIR/contributor-scores.txt $LEDGER_DIR/contributor-rank.svg") \
            --title "$TITLE" \
            --notes "$NOTES" || true

      # ---------------------------------------------------------
      - name: ðŸ“¦ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gcrust-${{ matrix.os }}-v3.3-${{ github.run_number }}
          path: |
            $BUILD_DIR/
            $LEDGER_DIR/
