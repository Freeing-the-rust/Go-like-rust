name: ðŸ›ï¸ Go-like-Rust Transpiler (v3.5 â€” 3OS Release + Auto README Update)

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

env:
  BUILD_DIR: build/transpiled
  LEDGER_DIR: proof

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      # ---------------------------------------------------------
      - name: ðŸ§­ Checkout repository (OS-safe)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false
        shell: pwsh

      # ---------------------------------------------------------
      - name: âš™ï¸ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"

      - name: âš™ï¸ Prepare Environment
        shell: bash
        run: |
          mkdir -p "$BUILD_DIR" "$LEDGER_DIR"
          echo "ðŸ Runner: ${{ matrix.os }}"
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            sudo apt-get update -y && sudo apt-get install -y gnuplot
          fi

      # ---------------------------------------------------------
      - name: ðŸ—ï¸ Build Go-like-Rust
        id: build
        shell: bash
        run: |
          go mod tidy
          GOOS=$(echo "${{ matrix.os }}" | cut -d'-' -f1)
          EXT=""
          [ "$GOOS" = "windows" ] && EXT=".exe"
          OUTPUT="$BUILD_DIR/gcrust-${GOOS}${EXT}"
          if go build -o "$OUTPUT" main.go; then
            echo "âœ… Build Success"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Build Failed"
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

      # ---------------------------------------------------------
      - name: ðŸ§¾ Record contributor ledger
        shell: bash
        run: |
          AUTHOR="${{ github.actor }}"
          EMAIL=$(git log -1 --pretty=format:'%ae')
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          echo "[$TIMESTAMP] $AUTHOR <$EMAIL> â€” built on ${{ matrix.os }}" >> "$LEDGER_DIR/contributor-ledger.txt"

      # ---------------------------------------------------------
      - name: ðŸ“ˆ Contributor Stats (Linux only)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          echo "ðŸ‘¥ Contributor Statistics â€” $(date -u)" > "$LEDGER_DIR/contributor-scores.txt"
          rm -f "$LEDGER_DIR/contributor-rank-data.txt"
          for email in $(git log --format='%ae' | sort | uniq); do
            chars=$(git log --author="$email" --pretty=tformat: --numstat | awk '{add+=$1} END {print add}')
            name=$(git log --author="$email" --pretty="%aN" | head -n 1)
            printf "%-25s â€” %10d chars\n" "$name <$email>" "$chars" >> "$LEDGER_DIR/contributor-scores.txt"
            echo "$name $chars" >> "$LEDGER_DIR/contributor-rank-data.txt"
          done
          if [ -s "$LEDGER_DIR/contributor-rank-data.txt" ]; then
            cd "$LEDGER_DIR"
            sort -k2 -nr contributor-rank-data.txt > rank-sorted.txt
            echo "set terminal svg size 900,400; \
                  set output 'contributor-rank.svg'; \
                  set title 'Go-like-Rust Contributor Ranking'; \
                  set style data histograms; \
                  set style fill solid; \
                  set ylabel 'Characters Added'; \
                  set xtics rotate by -25; \
                  plot 'rank-sorted.txt' using 2:xtic(1) title 'Char Count'" | gnuplot
          fi

      # ---------------------------------------------------------
      - name: ðŸ¥‡ Extract Top3 Contributors (Linux only)
        if: matrix.os == 'ubuntu-latest'
        id: top3
        shell: bash
        run: |
          cd "$LEDGER_DIR"
          sort -k2 -nr contributor-rank-data.txt | head -n 3 > top3.txt
          echo "top1=$(awk 'NR==1{print $1}' top3.txt)" >> $GITHUB_OUTPUT
          echo "top2=$(awk 'NR==2{print $1}' top3.txt)" >> $GITHUB_OUTPUT
          echo "top3=$(awk 'NR==3{print $1}' top3.txt)" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------
      - name: ðŸ§© Auto-update README (Linux only)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          STATUS="${{ steps.build.outputs.status }}"
          STATUS_CLEAN=$(echo "$STATUS" | tr ' ' '_' | tr -d '[:punct:]')
          BADGE="![Build](https://img.shields.io/badge/build-${STATUS_CLEAN}-blue.svg)"
          COMMITS=$(git rev-list --count HEAD)
          CONTRIBUTORS=$(git log --format='%aN' | sort -u | wc -l)
          UPDATED=$(date -u '+%Y-%m-%d %H:%M UTC')
          TOP1="${{ steps.top3.outputs.top1 }}"
          TOP2="${{ steps.top3.outputs.top2 }}"
          TOP3="${{ steps.top3.outputs.top3 }}"
          GRAPH_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/${LEDGER_DIR}/contributor-rank.svg"

          echo "ðŸª¶ Updating README..."
          sed -i '/## ðŸ—ï¸ Build Status/,$d' README.md 2>/dev/null || true
          {
            echo "# ðŸ§© Go-like-Rust Transpiler"
            echo ""
            echo "ðŸ“Š **Commits:** $COMMITSâ€ƒðŸ‘¥ **Contributors:** $CONTRIBUTORSâ€ƒðŸ•’ **Updated:** $UPDATED"
            echo ""
            echo "ðŸ† **Top Contributors:** ðŸ¥‡ $TOP1â€ƒðŸ¥ˆ $TOP2â€ƒðŸ¥‰ $TOP3"
            echo ""
            echo "## ðŸ—ï¸ Build Status"
            echo ""
            echo "$BADGE"
            echo ""
            echo "## ðŸ† Contributor Ranking"
            echo ""
            echo "![Contributor Rank Graph]($GRAPH_URL)"
            echo ""
            echo "_(Auto-generated by CI â€” per OS build, rank & stats)_"
          } > README.md

          git add README.md
          git commit -m "ðŸ“Š Auto-update README (stats + top3 + badge)" || echo "No changes"
          git push origin main || true

      # ---------------------------------------------------------
      - name: ðŸŒ€ Create OS-specific release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          GOOS=$(echo "${{ matrix.os }}" | cut -d'-' -f1)
          TAG="snapshot-${GOOS}-v3.5-${{ github.run_number }}"
          TITLE="Go-like-Rust v3.5 â€” ${GOOS^} Release Snapshot"
          NOTES="Independent release for $GOOS â€” build completed at $(date -u)"
          echo "ðŸŒ€ Creating $TITLE"
          gh release delete "$TAG" --yes || true
          gh release create "$TAG" \
            "$BUILD_DIR/gcrust-${GOOS}"* \
            "$LEDGER_DIR/contributor-ledger.txt" \
            $([ "$GOOS" = "linux" ] && echo "$LEDGER_DIR/contributor-scores.txt $LEDGER_DIR/contributor-rank.svg $LEDGER_DIR/top3.txt") \
            --title "$TITLE" \
            --notes "$NOTES" || true

      # ---------------------------------------------------------
      - name: ðŸ“¦ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gcrust-${{ matrix.os }}-v3.5-${{ github.run_number }}
          path: |
            $BUILD_DIR/
            $LEDGER_DIR/
