name: "Go-like-Rust Transpiler â€” All is Heap (Heap-Hop Edition v4.10.5 / Go Executable Release)"

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ closed ]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

# --- ğŸš€ Centralized Versioning ---
# ì•± ë²„ì „ì„ ì´ê³³ í•œ êµ°ë°ì—ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤.
env:
  APP_VERSION: "v4.10.5"

permissions:
  contents: read

concurrency:
  group: go-like-rust-heap-hop-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-3os:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
          check-latest: true
          cache: true

      # --- ğŸš€ IMPROVEMENT 1: Flexible Python Setup ---
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          # .python-version íŒŒì¼ì„ ì°¾ëŠ” ëŒ€ì‹  3.11ë¡œ ë²„ì „ì„ ê³ ì •í•©ë‹ˆë‹¤.
          # ì´ë ‡ê²Œ í•˜ë©´ fallback-python-version ì˜¤ë¥˜ì™€ .python-version íŒŒì¼ ì—†ìŒ ì˜¤ë¥˜ê°€ ëª¨ë‘ í•´ê²°ë©ë‹ˆë‹¤.
          python-version: '3.11'
          # 'cache: 'pip''ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
          # ì´ ì„¤ì •ì€ requirements.txt ë˜ëŠ” pyproject.toml íŒŒì¼ì´ *ë°˜ë“œì‹œ* ì¡´ì¬í•´ì•¼ í•˜ë¯€ë¡œ,
          # í•´ë‹¹ íŒŒì¼ì´ ì„ íƒ ì‚¬í•­ì¸ ì´ ì›Œí¬í”Œë¡œì—ì„œëŠ” ì˜¤ë¥˜ë¥¼ ìœ ë°œí•©ë‹ˆë‹¤.

      # --- ğŸš€ IMPROVEMENT 2: Install Python Dependencies ---
      - name: Install Python Dependencies (if any)
        run: |
          if [ -f "requirements.txt" ]; then
            echo "requirements.txt found, installing dependencies..."
            pip install -r requirements.txt
          else
            echo "No requirements.txt found, skipping pip install."
          fi

      - name: Transpile Rust to Go (Unified)
        run: |
          set -euo pipefail
          mkdir -p build transpiled proof ledger
          
          echo "âš™ï¸ Translating Rust to Go-like heap-based code..."
          
          TRANSPILER="scripts/translate_rust_to_go.py"
          GENERATED=false
          
          if [ -f "$TRANSPILER" ]; then
            echo "Found Python transpiler â€” executing with 'python'..."
            
            # (Python ì˜¤ë¥˜ê°€ ë³´ì´ë„ë¡ 2>/dev/null ì œê±°ë¨)
            if python "$TRANSPILER" src/ > transpiled/main.go; then
              echo "âœ… Transpilation successful."
              GENERATED=true
            else
              echo "âš ï¸ Python transpiler execution failed. Check logs above for Python errors."
            fi
          fi

          if [ "$GENERATED" = false ]; then
            echo "âš ï¸ Using fallback Go file."
            cat <<EOF > transpiled/main.go
          package main
          import (
            "bufio"
            "fmt"
            "os"
          )
          func main() {
            fmt.Println("All is heap â€” Heap-Hop Edition running.")
            fmt.Println("Every value lives on the heap.")
            fmt.Println("Press ENTER to exit.")
            reader := bufio.NewReader(os.Stdin)
            _, _ = reader.ReadBytes('\n')
          }
          EOF
          fi

      - name: Build Go Executable
        run: |
          set -euo pipefail
          cd transpiled
          
          GOOS_NAME=$(echo "${{ runner.os }}" | tr '[:upper:]' '[:lower:]')
          OUT="../build/go_like_rust_${GOOS_NAME}"
          
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            OUT="${OUT}.exe"
          fi
          
          echo "Building for $GOOS_NAME..."
          go build -trimpath -ldflags="-s -w" -o "${OUT}" main.go
          
          cd ..
          {
            echo "Version: ${{ env.APP_VERSION }}"
            date -u +"Build Time (UTC): %Y-%m-%dT%H:%M:%SZ"
            echo "Commit Hash: ${{ github.sha }}"
            echo "Runner OS: ${{ runner.os }}"
          } > "ledger/build-info-${GOOS_NAME}.txt"

      - name: Generate SHA256 Checksums
        run: |
          set -euo pipefail
          mkdir -p proof
          
          if command -v sha256sum >/dev/null 2>&1; then
            find build -type f -print0 | xargs -0 sha256sum | sort > "proof/sha256sum-${{ matrix.os }}.txt"
          else
            find build -type f -exec shasum -a 256 "{}" \; | sort > "proof/sha256sum-${{ matrix.os }}.txt"
          fi

      - name: Archive Artifacts
        run: |
          set -euo pipefail
          mkdir -p release-assets
          ZIP="release-assets/go-like-rust-${{ matrix.os }}.zip"
          
          # ğŸš€ FIX: 'zip'ì€ Windowsì— ì—†ì§€ë§Œ '7z'ëŠ” ìˆìŠµë‹ˆë‹¤.
          # 'zip'ì´ ìˆìœ¼ë©´ ì‚¬ìš©í•˜ê³ , ì—†ìœ¼ë©´ '7z'ë¥¼ ì‚¬ìš©í•˜ë„ë¡ í´ë°±ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
          if command -v zip >/dev/null 2>&1; then
            echo "Using zip..."
            zip -rq "$ZIP" build proof ledger transpiled
          elif command -v 7z >/dev/null 2>&1; then
            echo "Using 7z for Windows..."
            # 'a' (add to archive), '-tzip' (set archive type to zip), '-r' (recursive)
            # 7zì€ ì¶œë ¥ì´ ë§¤ìš° ë§ìœ¼ë¯€ë¡œ /dev/nullë¡œ ë¦¬ë””ë ‰ì…˜í•©ë‹ˆë‹¤.
            7z a -tzip -r "$ZIP" ./build ./proof ./ledger ./transpiled > /dev/null
          else
            echo "Error: Neither zip nor 7z found. Cannot archive artifacts."
            exit 1
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: go-like-rust-${{ matrix.os }}-${{ github.run_id }}
          path: release-assets/go-like-rust-${{ matrix.os }}.zip
          if-no-files-found: error
          retention-days: 3

  finalize:
    runs-on: ubuntu-latest
    needs: build-3os
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          pattern: "go-like-rust-*"
          merge-multiple: true

      - name: Extract proof/ledger
        run: |
          set -euo pipefail
          mkdir -p proof ledger
          for z in release-assets/*.zip; do
            unzip -qo "$z" "proof/*" "ledger/*" -d tmp || true
            cp -R tmp/proof/* proof/ 2>/dev/null || true
            cp -R tmp/ledger/* ledger/ 2>/dev/null || true
            rm -rf tmp
          done

      - name: Commit & Push ProofLedger
        env:
          COMMIT_MSG: "Proof/Ledger sync (${{ env.APP_VERSION }}) [skip ci]"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git pull --rebase --autostash || true
          
          # (README ìˆ˜ì • ë¡œì§ì€ ìœ ì§€)
          if ! grep -q "### Main Branch Open" README.D; then
            echo -e "\n### Main Branch Open\nThe main branch is open for contributions via PR or Issues." >> README.md
          fi
          
          git add README.md proof ledger || true
          
          if ! git diff --cached --quiet; then
            git commit -m "$COMMIT_MSG"
            git push
          else
            echo "No changes to commit."
          fi

      # --- ğŸš€ IMPROVEMENT 3: Dynamic Release Notes ---
      - name: Aggregate Proof & Ledger for Release
        id: release_notes
        run: |
          # ë¦´ë¦¬ìŠ¤ ë³¸ë¬¸ ìƒì„±
          BODY_FILE="release_notes_body.md"
          
          echo "Go-like-Rust Transpiler â€” All is Heap (${{ env.APP_VERSION }})" > $BODY_FILE
          echo "âš™ï¸ Everything lives on the heap." >> $BODY_FILE
          echo "" >> $BODY_FILE
          echo "## ğŸ” SHA256 Checksums (Proof)" >> $BODY_FILE
          echo '```text' >> $BODY_FILE
          cat proof/sha256sum-*.txt >> $BODY_FILE
          echo '```' >> $BODY_FILE
          echo "" >> $BODY_FILE
          echo "## â„¹ï¸ Build Details (Ledger)" >> $BODY_FILE
          echo '```text' >> $BODY_FILE
          cat ledger/build-info-*.txt >> $BODY_FILE
          echo '```' >> $BODY_FILE

          # GITHUB_OUTPUTì— ë©€í‹°ë¼ì¸ ë¬¸ìì—´ ì „ë‹¬
          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat $BODY_FILE >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: heap-hop-${{ env.APP_VERSION }}
          name: "Heap-Hop Edition â€” All is Heap Executable (Go-like Rust Transpiler ${{ env.APP_VERSION }})"
          # ì´ì „ ë‹¨ê³„ì—ì„œ ìƒì„±í•œ ë™ì  ë³¸ë¬¸ ì‚¬ìš©
          body: ${{ steps.release_notes.outputs.body }}
          files: release-assets/*.zip
          allowUpdates: true
