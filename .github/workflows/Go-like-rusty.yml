name: Go-like-Rust - Heap-Hop Multi-Stage Build (Rust ‚Üí Go ‚Üí SpongeLang ‚Üí NASM)

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

env:
  APP_VERSION: "v4.10.6"

permissions:
  contents: read

concurrency:
  group: go-like-rust-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-3os:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
      fail-fast: false

    defaults:
      run:
        shell: bash

    steps:
      # ------------------------------
      # Stage 1: Checkout + Setup
      # ------------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
          check-latest: true
          cache: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python Dependencies
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            echo "No Python dependencies."
          fi

      # ------------------------------
      # Stage 2: Rust ‚Üí Go
      # ------------------------------
      - name: Transpile Rust ‚Üí Go
        run: |
          set -euo pipefail
          mkdir -p build transpiled proof ledger asm

          TRANSPILER="scripts/translate_rust_to_go.py"
          GENERATED=false

          echo "üî• Transpiling Rust ‚Üí Go..."

          if [ -f "$TRANSPILER" ]; then
            if python "$TRANSPILER" src/ > transpiled/main.go; then
              GENERATED=true
              echo "üü¢ Rust‚ÜíGo transpilation OK."
            else
              echo "‚ö†Ô∏è Transpiler failed, using fallback Go file."
            fi
          else
            echo "‚ö†Ô∏è No transpiler found, using fallback Go file."
          fi

          if [ "$GENERATED" = false ]; then
            cat << 'EOF' > transpiled/main.go
package main
import (
  "bufio"
  "fmt"
  "os"
)
func main() {
  fmt.Println("All is heap - Go-like-Rust fallback.")
  reader := bufio.NewReader(os.Stdin)
  _, _ = reader.ReadBytes('\n')
}
EOF
          fi

      # ------------------------------
      # Stage 3: Go ‚Üí SpongeLang Meaning IR
      # ------------------------------
      - name: Extract Meaning (Go ‚Üí SpongeLang IR)
        run: |
          set -euo pipefail

          MEANING="scripts/go_to_sponge_meaning.py"

          echo "üß† Extracting SpongeLang Meaning from Go..."

          if python "$MEANING" transpiled/main.go > transpiled/meaning.ir; then
            echo "üü¢ Meaning extraction OK."
          else
            echo "‚ùå Meaning extraction failed."
            exit 1
          fi

      # ------------------------------
      # Stage 4: SpongeLang IR ‚Üí NASM Assembly
      # ------------------------------
      - name: Generate NASM Assembly
        run: |
          set -euo pipefail

          NASM_GEN="scripts/sponge_to_nasm.py"

          echo "‚öôÔ∏è Generating NASM assembly..."

          if python "$NASM_GEN" transpiled/meaning.ir > asm/main.asm; then
            echo "üü¢ NASM generated."
          else
            echo "‚ùå NASM generation failed."
            exit 1
          fi

      # ------------------------------
      # Stage 5: NASM ‚Üí Executable
      # ------------------------------
      - name: Build Executable via NASM
        run: |
          set -euo pipefail

          GOOS_NAME=$(echo "${{ runner.os }}" | tr '[:upper:]' '[:lower:]')

          OUT="build/spongelang_${GOOS_NAME}"

          echo "üî® Building NASM executable for ${GOOS_NAME}..."

          if [[ "${{ runner.os }}" == "Windows" ]]; then
            nasm -f win64 asm/main.asm -o asm/main.obj
            link.exe /SUBSYSTEM:CONSOLE asm/main.obj /OUT:${OUT}.exe
          else
            nasm -felf64 asm/main.asm -o asm/main.o
            ld asm/main.o -o ${OUT}
          fi

          {
            echo "Version: ${{ env.APP_VERSION }}"
            date -u +"Build Time (UTC): %Y-%m-%dT%H:%M:%SZ"
            echo "Commit: ${{ github.sha }}"
            echo "Pipeline: Rust ‚Üí Go ‚Üí SpongeLang ‚Üí NASM"
            echo "OS: ${{ runner.os }}"
          } > ledger/build-info-${GOOS_NAME}.txt

      # ------------------------------
      # Stage 6: SHA256 Proof
      # ------------------------------
      - name: SHA256 Proof
        run: |
          mkdir -p proof
          if command -v sha256sum >/dev/null 2>&1; then
            find build -type f -print0 | xargs -0 sha256sum | sort > proof/sha256sum-${{ matrix.os }}.txt
          else
            find build -type f -exec shasum -a 256 "{}" \; | sort > proof/sha256sum-${{ matrix.os }}.txt
          fi

      # ------------------------------
      # Stage 7: ZIP Packaging
      # ------------------------------
      - name: Create ZIP
        run: |
          mkdir -p release-assets
          ZIP="release-assets/go-like-rust-${{ matrix.os }}.zip"

          if command -v zip >/dev/null 2>&1; then
            zip -rq "$ZIP" build proof ledger transpiled asm
          elif command -v 7z >/dev/null 2>&1; then
            7z a -tzip -r "$ZIP" ./build ./proof ./ledger ./transpiled ./asm > /dev/null
          else
            echo "‚ùå No archiver available."
            exit 1
          fi

      # ------------------------------
      # Stage 8: Upload Artifacts
      # ------------------------------
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: go-like-rust-${{ matrix.os }}-${{ github.run_id }}
          path: release-assets/go-like-rust-${{ matrix.os }}.zip
          retention-days: 3

  # =====================================================================
  # FINALIZE JOB (Collect ‚Üí Commit ‚Üí Release)
  # =====================================================================
  finalize:
    name: Finalize Release
    runs-on: ubuntu-latest
    needs: build-3os
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          pattern: "go-like-rust-*"
          merge-multiple: true

      - name: Extract Proof & Ledger
        run: |
          mkdir -p proof ledger
          for z in release-assets/*.zip; do
            unzip -qo "$z" "proof/*" "ledger/*" -d tmp || true
            cp -R tmp/proof/* proof/ 2>/dev/null || true
            cp -R tmp/ledger/* ledger/ 2>/dev/null || true
            rm -rf tmp
          done

      - name: Commit Proof/Ledger
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git pull --rebase --autostash || true
          git add proof ledger

          if ! git.diff --cached --quiet; then
            git commit -m "Proof/Ledger sync (${{ env.APP_VERSION }}) [skip ci]"
            git push
          else
            echo "No changes."
          fi

      - name: Build Release Body
        id: release_notes
        run: |
          BODY="release_body.md"

          echo "Go-like-Rust - Heap-Hop Multi Stage Edition (${{ env.APP_VERSION }})" > $BODY
          echo "" >> $BODY

          echo "## üîê SHA256 Proof" >> $BODY
          echo '```' >> $BODY
          cat proof/sha256sum-*.txt >> $BODY
          echo '```' >> $BODY

          echo "" >> $BODY
          echo "## üßæ Build Ledger" >> $BODY
          echo '```' >> $BODY
          cat ledger/build-info-*.txt >> $BODY
          echo '```' >> $BODY

          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat $BODY >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create / Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: heap-hop-${{ env.APP_VERSION }}
          name: "Heap-Hop Meaning Build (Rust ‚Üí Go ‚Üí SpongeLang ‚Üí NASM) ${{ env.APP_VERSION }}"
          body: ${{ steps.release_notes.outputs.body }}
          files: release-assets/*.zip
          overwrite_files: true
