name: üèõÔ∏è Go-like-Rust Transpiler (v2.4 ‚Äî Foundation Edition)

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 0 * * *"     # Îß§Ïùº ÏûêÏ†ï UTC
  workflow_dispatch:

permissions:
  contents: write

env:
  BUILD_DIR: build/transpiled
  LEDGER_DIR: proof
  SNAPSHOT_TAG: snapshot-transpile-${{ github.run_number }}
  BACKUP_REPO: r3c-foundation/r3c-backup

jobs:
  transpile:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      - name: üß≠ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------------------------------------
      - name: ‚öôÔ∏è Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"

      # ---------------------------------------------------------
      - name: üßæ Ensure Go module
        run: |
          if [ ! -f go.mod ]; then
            echo "Initializing Go module (gcrust)"
            go mod init gcrust
          fi
          go mod tidy

      # ---------------------------------------------------------
      - name: üß© Prepare directories
        run: |
          mkdir -p "$GITHUB_WORKSPACE/$BUILD_DIR" "$GITHUB_WORKSPACE/$LEDGER_DIR" diff proof_history

      # ---------------------------------------------------------
      - name: ü¶Ä Transpile Rust-like sources
        run: |
          echo "=== Go-like-Rust Transpile Run ($(date -u)) ==="
          for f in $(find examples -name '*.rs' 2>/dev/null); do
            echo "‚û°Ô∏è  Transpiling: $f"
            go run main.go transpile "$f" || echo "‚ö†Ô∏è Transpile failed for $f"
          done
          find examples -name '*_gen.go' -exec cp {} "$GITHUB_WORKSPACE/$BUILD_DIR" \; || true

      # ---------------------------------------------------------
      - name: üß™ Run transpiled outputs
        run: |
          for g in $(find "$GITHUB_WORKSPACE/$BUILD_DIR" -name '*_gen.go' 2>/dev/null); do
            echo "‚ñ∂Ô∏è Running: $g"
            go run "$g" || echo "‚ö†Ô∏è Run failed: $g"
          done
          echo "‚úÖ Execution checks complete"

      # ---------------------------------------------------------
      - name: üîí Generate ProofLedger
        run: |
          mkdir -p "$GITHUB_WORKSPACE/$LEDGER_DIR"
          cd "$GITHUB_WORKSPACE/$BUILD_DIR" || exit 0

          FILES=$(ls *_gen.go 2>/dev/null || true)
          if [ -n "$FILES" ]; then
            sha256sum *_gen.go > "$GITHUB_WORKSPACE/$LEDGER_DIR/SHA256SUMS.txt"
          else
            echo "No generated Go files found." > "$GITHUB_WORKSPACE/$LEDGER_DIR/SHA256SUMS.txt"
          fi

          cd "$GITHUB_WORKSPACE/$LEDGER_DIR"
          {
            echo "GO-LIKE-RUST TRANSPILER PROOFLEDGER ‚Äî $(date -u)"
            echo "Generated Files: $(ls $GITHUB_WORKSPACE/$BUILD_DIR | wc -l)"
            echo "UTC Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            cat SHA256SUMS.txt
          } > ProofLedger.txt
          echo "‚úÖ ProofLedger generated"

      # ---------------------------------------------------------
      - name: üîç Compare with previous ledger (ProofLedgerDiff)
        run: |
          mkdir -p diff proof_history
          PREV=$(ls proof_history/ProofLedger-*.txt 2>/dev/null | tail -n 1 || true)
          if [ -n "$PREV" ]; then
            diff -u "$PREV" "$GITHUB_WORKSPACE/$LEDGER_DIR/ProofLedger.txt" > diff/ProofLedgerDiff.txt || true
          else
            echo "No previous ProofLedger found" > diff/ProofLedgerDiff.txt
          fi
          cp "$GITHUB_WORKSPACE/$LEDGER_DIR/ProofLedger.txt" "proof_history/ProofLedger-$(date -u +%Y%m%d-%H%M).txt" || true
          echo "‚úÖ ProofLedgerDiff updated"

      # ---------------------------------------------------------
      - name: üßæ Commit & Push ledger + generated code
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$BUILD_DIR"/* "$LEDGER_DIR"/* diff/* proof_history/* || true
          git commit -m "üèõÔ∏è v2.4 ProofLedger + Diff update" || echo "No changes to commit"
          git push origin main || echo "‚úÖ No push needed"

      # ---------------------------------------------------------
      - name: üåÄ Create snapshot release (fail-safe)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üåÄ Creating release: $SNAPSHOT_TAG"
          gh release delete "$SNAPSHOT_TAG" --yes || true

          FILES=$(find "$GITHUB_WORKSPACE/$BUILD_DIR" -name '*.go' 2>/dev/null)
          if [ -z "$FILES" ]; then
            echo "‚ö†Ô∏è No transpiled .go files found ‚Äî skipping release creation."
            exit 0
          fi

          gh release create "$SNAPSHOT_TAG" $FILES "$GITHUB_WORKSPACE/$LEDGER_DIR"/ProofLedger.txt diff/ProofLedgerDiff.txt \
            --title "Go-like-Rust Transpile Snapshot v2.4" \
            --notes "Automated transpile + verification ‚Äî $(date -u)" || echo "‚ö†Ô∏è Release creation failed (non-fatal)"

      # ---------------------------------------------------------
      - name: üåê Mirror to backup repository (dual sync)
        if: github.ref == 'refs/heads/main'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üîÅ Syncing to backup repository: $BACKUP_REPO"
          git remote add backup "https://github.com/$BACKUP_REPO.git" || true
          git push backup main || echo "‚ö†Ô∏è Backup sync failed (non-fatal)"

      # ---------------------------------------------------------
      - name: ü§ù Ensure README has contribution section
        run: |
          if ! grep -q "## ü§ù Contributing" README.md 2>/dev/null; then
            echo "" >> README.md
            echo "## ü§ù Contributing" >> README.md
            echo "Contributions are welcome!" >> README.md
            echo "" >> README.md
            echo "If you'd like to improve Go-like-Rust, open a Pull Request." >> README.md
            echo "" >> README.md
            echo "_(This section was automatically added by CI)_" >> README.md
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add README.md
            git commit -m "ü§ù Auto-add contribution section to README" || echo "No changes"
            git push origin main || echo "‚úÖ No push needed"
          else
            echo "‚úÖ README already has a contribution section."
          fi

      # ---------------------------------------------------------
      - name: üë• Update Contributors section in README
        run: |
          echo "üîç Collecting contributors..."
          CONTRIBUTORS=$(git log --format='%aN <%aE>' | sort | uniq)
          if ! grep -q "## üë• Contributors" README.md 2>/dev/null; then
            echo "" >> README.md
            echo "## üë• Contributors" >> README.md
          else
            sed -i '/## üë• Contributors/,$d' README.md
            echo "## üë• Contributors" >> README.md
          fi
          echo "" >> README.md
          echo "$CONTRIBUTORS" | awk '{print "- " $0}' >> README.md
          echo "" >> README.md
          echo "_(This list is automatically updated by CI)_" >> README.md
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "üë• Auto-update contributors section in README" || echo "No changes"
          git push origin main || echo "‚úÖ No push needed"

      # ---------------------------------------------------------
      - name: üßæ Update AUTHORS.md
        run: |
          if [ ! -f AUTHORS.md ]; then
            echo "# üë• Contributors" > AUTHORS.md
            echo "" >> AUTHORS.md
          fi
          AUTHOR_NAME="${{ github.actor }}"
          AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')
          ENTRY="- ${AUTHOR_NAME} <${AUTHOR_EMAIL}>"
          if ! grep -q "${AUTHOR_NAME}" AUTHORS.md; then
            echo "$ENTRY" >> AUTHORS.md
            git add AUTHORS.md
            git commit -m "ü§ù Add contributor ${AUTHOR_NAME}" || echo "No changes"
            git push origin main || echo "‚úÖ No push needed"
          else
            echo "‚úÖ Contributor already listed."
          fi

      # ---------------------------------------------------------
      - name: üì¶ Upload artifacts (proof + diff)
        uses: actions/upload-artifact@v4
        with:
          name: transpile-proof-v2.4-${{ github.run_number }}
          path: |
            $BUILD_DIR/
            $LEDGER_DIR/
            diff/
            proof_history/
