name: üèõÔ∏è Go-like-Rust Transpiler (v2.9 ‚Äî Foundation with README Rank Embed Edition)

on:
  push:
    branches: [main]
  pull_request:
    types: [closed]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

env:
  BUILD_DIR: build/transpiled
  LEDGER_DIR: proof
  SNAPSHOT_TAG: snapshot-transpile-${{ github.run_number }}
  BACKUP_REPO: r3c-foundation/r3c-backup

jobs:
  transpile:
    runs-on: ubuntu-latest

    steps:
      - name: üß≠ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup environment
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gnuplot
          mkdir -p "$GITHUB_WORKSPACE/$LEDGER_DIR"

      # ---------------------------------------------------------
      - name: üßæ Record contributor ledger
        run: |
          AUTHOR="${{ github.actor }}"
          EMAIL=$(git log -1 --pretty=format:'%ae')
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          echo "[$TIMESTAMP] $AUTHOR <$EMAIL>" >> "$LEDGER_DIR/contributor-ledger.txt"
          echo "‚úÖ Contributor ledger updated with $AUTHOR"

      # ---------------------------------------------------------
      - name: üßÆ Calculate character-based contribution scores
        run: |
          echo "üë• Character-Based Contribution Scores ‚Äî $(date -u)" > "$LEDGER_DIR/contributor-scores.txt"
          echo "" >> "$LEDGER_DIR/contributor-scores.txt"

          rm -f "$LEDGER_DIR/contributor-rank-data.txt"
          for email in $(git log --format='%ae' | sort | uniq); do
            total_chars=$(git log --author="$email" --pretty=tformat: --numstat | awk '{add+=$1} END {print add}')
            name=$(git log --author="$email" --pretty="%aN" | head -n 1)
            [ -z "$total_chars" ] && total_chars=0
            printf "%-25s ‚Äî %10d chars\n" "$name <$email>" "$total_chars" >> "$LEDGER_DIR/contributor-scores.txt"
            echo "$name $total_chars" >> "$LEDGER_DIR/contributor-rank-data.txt"
          done

          echo "" >> "$LEDGER_DIR/contributor-scores.txt"
          echo "_(Character count = total added characters across commits)_" >> "$LEDGER_DIR/contributor-scores.txt"
          echo "‚úÖ Contributor character scores updated"

      # ---------------------------------------------------------
      - name: üìà Generate contributor rank SVG
        run: |
          cd "$LEDGER_DIR"
          if [ -s contributor-rank-data.txt ]; then
            sort -k2 -nr contributor-rank-data.txt > rank-sorted.txt
            echo "set terminal svg size 800,400; \
                  set output 'contributor-rank.svg'; \
                  set title 'Go-like-Rust Contributor Ranking'; \
                  set style data histograms; \
                  set style fill solid; \
                  set ylabel 'Characters Added'; \
                  set xtics rotate by -25; \
                  plot 'rank-sorted.txt' using 2:xtic(1) title 'Char Count'" | gnuplot
            echo "‚úÖ SVG graph generated at proof/contributor-rank.svg"
          else
            echo "‚ö†Ô∏è No rank data found, skipping SVG."
          fi

      # ---------------------------------------------------------
      - name: üß© Embed rank graph into README
        run: |
          GRAPH_PATH="proof/contributor-rank.svg"
          RAW_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/${GRAPH_PATH}"
          if [ -f "$GRAPH_PATH" ]; then
            echo "ü™∂ Embedding rank graph into README"
            # Í∏∞Ï°¥ Í∑∏ÎûòÌîÑ ÏÑπÏÖò ÏÇ≠Ï†ú
            sed -i '/## üèÜ Contributor Ranking/,$d' README.md 2>/dev/null || true
            echo "" >> README.md
            echo "## üèÜ Contributor Ranking" >> README.md
            echo "" >> README.md
            echo "![Contributor Rank Graph]($RAW_URL)" >> README.md
            echo "" >> README.md
            echo "_(This graph is auto-generated by CI ‚Äî updated on every push)_" >> README.md
            git add README.md
            git commit -m "üèÜ Auto-embed contributor rank graph in README" || echo "No changes"
            git push origin main || echo "‚úÖ No push needed"
          else
            echo "‚ö†Ô∏è No SVG graph found; skipping embed."
          fi

      # ---------------------------------------------------------
      - name: üåÄ Create release (with graph)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üåÄ Creating release: $SNAPSHOT_TAG"
          gh release delete "$SNAPSHOT_TAG" --yes || true
          gh release create "$SNAPSHOT_TAG" \
            "$GITHUB_WORKSPACE/$LEDGER_DIR/contributor-ledger.txt" \
            "$GITHUB_WORKSPACE/$LEDGER_DIR/contributor-scores.txt" \
            "$GITHUB_WORKSPACE/$LEDGER_DIR/contributor-rank.svg" \
            --title "Go-like-Rust Snapshot v2.9" \
            --notes "Contributor rank visualization embedded in README ‚Äî $(date -u)" || true

      # ---------------------------------------------------------
      - name: üì¶ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: contributor-rank-v2.9-${{ github.run_number }}
          path: |
            $LEDGER_DIR/
