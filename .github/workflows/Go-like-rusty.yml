name: Go-like-Rust - Heap-Hop Multi-Stage Build (Rust â†’ Go â†’ SpongeLang â†’ NASM)

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

env:
  APP_VERSION: "v4.10.8"

permissions:
  contents: read

concurrency:
  group: go-like-rust-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-3os:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
      fail-fast: false

    defaults:
      run:
        shell: bash

    steps:
      # =====================================================================
      # Stage 1: Checkout + Setup
      # =====================================================================
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
          check-latest: true
          cache: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python Dependencies
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            echo "No Python dependencies."
          fi

      # Windows: enable MSVC link.exe
      - name: Setup MSVC Developer Command Prompt
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      # Install NASM on macOS
      - name: Install NASM (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install nasm

      # Install NASM on Ubuntu
      - name: Install NASM (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt update
          sudo apt install -y nasm

      # =====================================================================
      # Stage 2: Rust â†’ Go
      # =====================================================================
      - name: Transpile Rust â†’ Go
        run: |
          set -euo pipefail
          mkdir -p build transpiled proof ledger asm

          TRANSPILER="scripts/translate_rust_to_go.py"
          GENERATED=false

          echo "ðŸ”¥ Transpiling Rust â†’ Go..."

          if [ -f "$TRANSPILER" ]; then
            if python "$TRANSPILER" src/ > transpiled/main.go; then
              GENERATED=true
              echo "ðŸŸ¢ Rustâ†’Go transpilation OK."
            else
              echo "âš ï¸ Transpiler failed, using fallback Go file."
            fi
          else
            echo "âš ï¸ No transpiler found, using fallback Go file."
          fi

          if [ "$GENERATED" = false ]; then
            echo "package main" > transpiled/main.go
            echo "import (" >> transpiled/main.go
            echo "  \"bufio\"" >> transpiled/main.go
            echo "  \"fmt\"" >> transpiled/main.go
            echo "  \"os\"" >> transpiled/main.go
            echo ")" >> transpiled/main.go
            echo "func main() {" >> transpiled/main.go
            echo "  fmt.Println(\"All is heap - Go-like-Rust fallback.\")" >> transpiled/main.go
            echo "  reader := bufio.NewReader(os.Stdin)" >> transpiled/main.go
            echo "  _, _ = reader.ReadBytes('\n')" >> transpiled/main.go
            echo "}" >> transpiled/main.go
          fi

      # =====================================================================
      # Stage 3: Go â†’ SpongeLang Meaning IR
      # =====================================================================
      - name: Extract Meaning (Go â†’ SpongeLang IR)
        run: |
          set -euo pipefail
          MEANING="scripts/go_to_sponge_meaning.py"

          echo "ðŸ§  Extracting SpongeLang Meaning from Go..."

          if python "$MEANING" transpiled/main.go > transpiled/meaning.ir; then
            echo "ðŸŸ¢ Meaning extraction OK."
          else
            echo "âŒ Meaning extraction failed."
            exit 1
          fi

      # =====================================================================
      # Stage 4: SpongeLang IR â†’ NASM Assembly
      # =====================================================================
      - name: Generate NASM Assembly
        run: |
          set -euo pipefail

          NASM_GEN="scripts/sponge_to_nasm.py"

          echo "âš™ï¸ Generating NASM assembly..."

          if python "$NASM_GEN" transpiled/meaning.ir > asm/main.asm; then
            echo "ðŸŸ¢ NASM generated."
          else
            echo "âŒ NASM generation failed."
            exit 1
          fi

      # =====================================================================
      # Stage 5: NASM â†’ Executable (3OS FULL VERSION)
      # =====================================================================

      # ------------------------------ Windows (PE64)
      - name: Build Executable via NASM (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
         echo ðŸ”¨ Windows NASM build...
         nasm -f win64 asm/main.asm -o asm/main.obj
         link.exe asm\main.obj kernel32.lib /ENTRY:main /SUBSYSTEM:CONSOLE /OUT:build\spongelang_windows.exe


         (
         echo Version: ${{ env.APP_VERSION }}
         echo Pipeline: Rust â†’ Go â†’ SpongeLang â†’ NASM
         echo OS: Windows
         ) > ledger/build-info-windows.txt


      # ------------------------------ Linux (ELF64)
      - name: Build Executable via NASM (Linux)
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail
          echo "ðŸ”¨ Linux NASM build..."

          nasm -felf64 asm/main.asm -o asm/main.o
          ld asm/main.o -o build/spongelang_ubuntu

          {
            echo "Version: ${{ env.APP_VERSION }}"
            date -u +"Build Time (UTC): %Y-%m-%dT%H:%M:%SZ"
            echo "Commit: ${{ github.sha }}"
            echo "Pipeline: Rust â†’ Go â†’ SpongeLang â†’ NASM"
            echo "OS: Linux"
          } > ledger/build-info-ubuntu.txt


      # ------------------------------ macOS (Mach-O 64bit)
      - name: Build Executable via NASM (macOS)
        if: runner.os == 'macOS'
        run: |
         set -euo pipefail
         echo "ðŸ”¨ macOS NASM build..."

         nasm -fmacho64 asm/main.asm -o asm/main.o

         SDKROOT="/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk"

         ld \
         -platform_version macos 11.0 11.0 \
         -arch x86_64 \
         -syslibroot "$SDKROOT" \
         -lSystem \
         -e _main \
         asm/main.o \
         -o build/spongelang_macos

         {
         echo "Version: ${{ env.APP_VERSION }}"
         date -u +"Build Time (UTC): %Y-%m-%dT%H:%M:%SZ"
         echo "Commit: ${{ github.sha }}"
         echo "Pipeline: Rust â†’ Go â†’ SpongeLang â†’ NASM"
         echo "OS: macOS"
         } > ledger/build-info-macos.txt


      # =====================================================================
      # Stage 6: SHA256 Proof
      # =====================================================================
      - name: SHA256 Proof
        run: |
          mkdir -p proof
          if command -v sha256sum >/dev/null 2>&1; then
            find build -type f -print0 | xargs -0 sha256sum | sort > proof/sha256sum-${{ matrix.os }}.txt
          else
            find build -type f -exec shasum -a 256 "{}" \; | sort > proof/sha256sum-${{ matrix.os }}.txt
          fi

      # =====================================================================
      # Stage 7: ZIP Packaging
      # =====================================================================
      - name: Create ZIP
        run: |
          case "${{ runner.os }}" in
            "Linux")   OSN="ubuntu" ;;
            "macOS")   OSN="macos" ;;
            "Windows") OSN="windows" ;;
          esac

          mkdir -p release-assets
          ZIP="release-assets/go-like-rust-${OSN}.zip"

          if command -v zip >/dev/null 2>&1; then
            zip -rq "$ZIP" build proof ledger transpiled asm
          elif command -v 7z >/dev/null 2>&1; then
            7z a -tzip -r "$ZIP" ./build ./proof ./ledger ./transpiled ./asm > /dev/null
          else
            echo "âŒ No archiver available."
            exit 1
          fi

      # =====================================================================
      # Stage 8: Upload Artifacts
      # =====================================================================
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: go-like-rust-${{ matrix.os }}-${{ github.run_id }}
          path: release-assets/*.zip
          retention-days: 3

  # =====================================================================
  # FINALIZE JOB (Collect â†’ Commit â†’ Release)
  # =====================================================================
  finalize:
    name: Finalize Release
    runs-on: ubuntu-latest
    needs: build-3os
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          pattern: "go-like-rust-*"
          merge-multiple: true

      - name: Extract Proof & Ledger
        run: |
          mkdir -p proof ledger
          for z in release-assets/*.zip; do
            unzip -qo "$z" "proof/*" "ledger/*" -d tmp || true
            cp -R tmp/proof/* proof/ 2>/dev/null || true
            cp -R tmp/ledger/* ledger/ 2>/dev/null || true
            rm -rf tmp
          done

      - name: Commit Proof/Ledger
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git pull --rebase --autostash || true
          git add proof ledger

          if ! git diff --cached --quiet; then
            git commit -m "Proof/Ledger sync (${{ env.APP_VERSION }}) [skip ci]"
            git push
          else
            echo "No changes."
          fi


      - name: Build Release Body
        id: release_notes
        run: |
          BODY="release_body.md"

          echo "Go-like-Rust - Heap-Hop Multi Stage Edition (${{ env.APP_VERSION }})" > $BODY
          echo "" >> $BODY

          echo "## ðŸ” SHA256 Proof" >> $BODY
          echo '```' >> $BODY
          cat proof/sha256sum-*.txt >> $BODY
          echo '```' >> $BODY

          echo "" >> $BODY
          echo "## ðŸ§¾ Build Ledger" >> $BODY
          echo '```' >> $BODY
          cat ledger/build-info-*.txt >> $BODY
          echo '```' >> $BODY

          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat $BODY >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create / Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: heap-hop-${{ env.APP_VERSION }}
          name: "Heap-Hop Meaning Build (Rust â†’ Go â†’ SpongeLang â†’ NASM) ${{ env.APP_VERSION }}"
          body: ${{ steps.release_notes.outputs.body }}
          files: release-assets/*.zip
          overwrite_files: true
