name: Go-like-Rust - Heap-Hop Build & Release

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

env:
  APP_VERSION: "v4.10.6"

permissions:
  contents: read

concurrency:
  group: go-like-rust-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-3os:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
          check-latest: true
          cache: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python Dependencies
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            echo "No Python dependencies."
          fi

      - name: Transpile Rust ‚Üí Go
        run: |
          set -euo pipefail
          mkdir -p build transpiled proof ledger

          TRANSPILER="scripts/translate_rust_to_go.py"
          GENERATED=false

          echo "üî• Transpiling Rust ‚Üí Go..."

          if [ -f "$TRANSPILER" ]; then
            if python "$TRANSPILER" src/ > transpiled/main.go; then
              GENERATED=true
              echo "üü¢ Transpilation OK."
            else
              echo "‚ö†Ô∏è Transpiler failed, using fallback."
            fi
          fi

          if [ "$GENERATED" = false ]; then
            cat << 'EOF' > transpiled/main.go
package main
import (
  "bufio"
  "fmt"
  "os"
)
func main() {
  fmt.Println("All is heap - Heap-Hop Edition running.")
  fmt.Println("Every value lives on the heap.")
  reader := bufio.NewReader(os.Stdin)
  _, _ = reader.ReadBytes('\n')
}
EOF
          fi

      - name: Build Go Executable
        run: |
          set -euo pipefail
          cd transpiled

          GOOS_NAME=$(echo "${{ runner.os }}" | tr '[:upper:]' '[:lower:]')
          OUT="../build/go_like_rust_${GOOS_NAME}"

          if [[ "${{ runner.os }}" == "Windows" ]]; then
            OUT="${OUT}.exe"
          fi

          echo "üî® Building for ${GOOS_NAME}..."
          go build -trimpath -ldflags="-s -w" -o "${OUT}" main.go

          cd ..

          {
            echo "Version: ${{ env.APP_VERSION }}"
            date -u +"Build Time (UTC): %Y-%m-%dT%H:%M:%SZ"
            echo "Commit: ${{ github.sha }}"
            echo "OS: ${{ runner.os }}"
          } > ledger/build-info-${GOOS_NAME}.txt

      - name: SHA256 Proof
        run: |
          mkdir -p proof
          if command -v sha256sum >/dev/null 2>&1; then
            find build -type f -print0 | xargs -0 sha256sum | sort > proof/sha256sum-${{ matrix.os }}.txt
          else
            find build -type f -exec shasum -a 256 "{}" \; | sort > proof/sha256sum-${{ matrix.os }}.txt
          fi

      - name: Create ZIP (zip / 7z fallback)
        run: |
          mkdir -p release-assets
          ZIP="release-assets/go-like-rust-${{ matrix.os }}.zip"

          if command -v zip >/dev/null 2>&1; then
            zip -rq "$ZIP" build proof ledger transpiled
          elif command -v 7z >/dev/null 2>&1; then
            7z a -tzip -r "$ZIP" ./build ./proof ./ledger ./transpiled > /dev/null
          else
            echo "‚ùå No zip or 7z available."
            exit 1
          fi

      - name: Upload ZIP Artifact
        uses: actions/upload-artifact@v4
        with:
          name: go-like-rust-${{ matrix.os }}-${{ github.run_id }}
          path: release-assets/go-like-rust-${{ matrix.os }}.zip
          retention-days: 3

  finalize:
    name: Finalize Release
    runs-on: ubuntu-latest
    needs: build-3os
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: release-assets
          pattern: "go-like-rust-*"
          merge-multiple: true

      - name: Extract Proof & Ledger
        run: |
          mkdir -p proof ledger
          for z in release-assets/*.zip; do
            unzip -qo "$z" "proof/*" "ledger/*" -d tmp || true
            cp -R tmp/proof/* proof/ 2>/dev/null || true
            cp -R tmp/ledger/* ledger/ 2>/dev/null || true
            rm -rf tmp
          done

      - name: Commit Proof/Ledger
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git pull --rebase --autostash || true

          git add proof ledger
          if ! git diff --cached --quiet; then
            git commit -m "Proof/Ledger sync (${{ env.APP_VERSION }}) [skip ci]"
            git push
          else
            echo "No changes."
          fi

      - name: Build Release Body
        id: release_notes
        run: |
          BODY="release_body.md"

          echo "Go-like-Rust - Heap-Hop Edition (${{ env.APP_VERSION }})" > $BODY
          echo "" >> $BODY
          echo "## üîê SHA256 Proof" >> $BODY
          echo '```' >> $BODY
          cat proof/sha256sum-*.txt >> $BODY
          echo '```' >> $BODY
          echo "" >> $BODY

          echo "## ‚ÑπÔ∏è Build Ledger" >> $BODY
          echo '```' >> $BODY
          cat ledger/build-info-*.txt >> $BODY
          echo '```' >> $BODY

          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat $BODY >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create / Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: heap-hop-${{ env.APP_VERSION }}
          name: "Heap-Hop Edition - All is Heap (Go-like-Rust ${{ env.APP_VERSION }})"
          body: ${{ steps.release_notes.outputs.body }}
          files: release-assets/*.zip
          overwrite_files: true
