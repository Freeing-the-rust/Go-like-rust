name: 'ğŸ›ï¸ Go-like-Rust Transpiler â€” *All is Heap (Heap-Hop Edition v4.1 / Go Executable Release)*'

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ closed ]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write
  actions: write

concurrency:
  group: go-like-rust-heap-hop-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-3os:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: "ğŸ§­ Checkout Repository"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Setup Go Environment"
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: "ğŸ§  Setup Python (for translator)"
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: "ğŸ“¦ Install Dependencies"
        shell: bash
        run: |
          echo "â–¶ï¸ Setting up environment for ${{ matrix.os }} (RUNNER_OS=$RUNNER_OS)"
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update && sudo apt-get install -y git zip unzip diffutils
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            brew install git gnu-sed diffutils || true
          elif [[ "$RUNNER_OS" == "Windows" ]]; then
            echo "Using preinstalled Git/Zip on Windows runner"
          fi

      - name: "ğŸ—ï¸ Transpile Rust â†’ Go (All is Heap Mode)"
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build transpiled proof ledger reports
          echo "âš™ï¸ Translating Rust to Go-like heap-based code..."
          if [ -f scripts/translate_rust_to_go.py ]; then
            bash -c '(python3 scripts/translate_rust_to_go.py src/ 2>/dev/null || python scripts/translate_rust_to_go.py src/) > transpiled/main.go'
          else
            cat > transpiled/main.go <<'EOF'
            package main

            import "fmt"

            func main() {
                fmt.Println("ğŸ›ï¸ All is heap â€” Heap-Hop Edition running.")
                fmt.Println("Every value lives on the heap.")
            }
          EOF
          fi
          echo "âœ… Transpilation complete â€” all heap variables, no stack life."

      - name: "ğŸ”¨ Build Go Executable"
        shell: bash
        run: |
          set -euo pipefail
          cd transpiled

          case "${RUNNER_OS}" in
            Linux)  GOOS_NAME="linux" ;;
            macOS)  GOOS_NAME="darwin" ;;
            Windows) GOOS_NAME="windows" ;;
            *) GOOS_NAME="$(echo "${{ matrix.os }}" | cut -d'-' -f1)" ;;
          esac

          OUT="../build/go_like_rust_${GOOS_NAME}"
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            go build -trimpath -ldflags="-s -w" -o "${OUT}.exe" main.go
          else
            go build -trimpath -ldflags="-s -w" -o "${OUT}" main.go
          fi
          cd ..

          echo "âœ… Go executable build complete on $(date -u)" > ledger/build-info-${GOOS_NAME}.txt
          echo "$(git config user.name || echo 'unknown') <$(git config user.email || echo 'unknown')> â€” heap-built on ${GOOS_NAME}" > ledger/contributor-ledger-${GOOS_NAME}.txt

      - name: "ğŸ§  RustSpec Detection (report fragment)"
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p proof reports
          SYNC_DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
          RUST_VERSION=$( (rustc --version 2>/dev/null) || echo "Rust not installed (heap-mode)" )
          echo "$RUST_VERSION" > "proof/current_rust_version-${{ matrix.os }}.txt"
          {
            echo "### Heap-Hop Auto-Report (${{ matrix.os }})"
            echo "- Last Synced: $SYNC_DATE"
            echo "- Detected RustSpec: $RUST_VERSION"
            echo "- Mode: All is Heap (Go Executable)"
          } > "reports/readme_fragment-${{ matrix.os }}.md"

      - name: "ğŸ” Generate SHA256 Proof"
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p proof
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sha256sum build/* > "proof/sha256sum-${{ matrix.os }}.txt"
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            for f in build/*; do
              shasum -a 256 "$f"
            done > "proof/sha256sum-${{ matrix.os }}.txt"
          else
            pwsh -NoLogo -NoProfile -Command 'Get-ChildItem build | ForEach-Object { $h = Get-FileHash $_.FullName -Algorithm SHA256; "$($h.Hash)  $($_.Name)" }' \
              > "proof/sha256sum-${{ matrix.os }}.txt"
          fi

      - name: "ğŸ“¦ Archive Artifacts"
        shell: bash
        run: |
          set -euo pipefail
          PKG="go-like-rust-${{ matrix.os }}.zip"
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            pwsh -NoLogo -NoProfile -Command "Compress-Archive -Path build,proof,ledger,transpiled -DestinationPath '$PKG' -Force"
          else
            zip -r "$PKG" build proof ledger transpiled
          fi
          echo "$PKG" > artifact-name.txt

      - name: "â¬†ï¸ Upload Build Artifacts (zip)"
        uses: actions/upload-artifact@v4
        with:
          name: go-like-rust-${{ matrix.os }}
          path: |
            go-like-rust-${{ matrix.os }}.zip
            artifact-name.txt

      - name: "â¬†ï¸ Upload Readme Fragment + Proof/Ledger (raw)"
        uses: actions/upload-artifact@v4
        with:
          name: raw-proof-and-fragments-${{ matrix.os }}
          path: |
            reports/readme_fragment-${{ matrix.os }}.md
            proof/**
            ledger/**

  finalize:
    runs-on: ubuntu-latest
    needs: build-3os

    steps:
      - name: "ğŸ§­ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ğŸ“¥ Download All Artifacts"
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          pattern: "*"
          merge-multiple: true

      - name: "ğŸ“¦ Unpack zips â†’ staging"
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p staging
          shopt -s nullglob
          for z in release-assets/*.zip; do
            unzip -o "$z" -d staging
          done

      - name: "ğŸ§¾ Assemble README Update + Sync Proof/Ledger"
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p proof ledger
          rsync -a --ignore-existing release-assets/proof/ proof/ || true
          rsync -a --ignore-existing release-assets/ledger/ ledger/ || true
          rsync -a staging/proof/ proof/ || true
          rsync -a staging/ledger/ ledger/ || true

          {
            echo ""
            echo "---"
            echo "## ğŸ§© Heap-Hop Edition Auto-Report (Consolidated)"
            echo "- Finalized: $(date -u '+%Y-%m-%d %H:%M UTC')"
            echo "- Runners: ubuntu-latest, macos-latest, windows-latest"
            echo ""
            for f in release-assets/reports/readme_fragment-*.md; do
              echo ""
              echo "#### Fragment: $(basename "$f")"
              sed 's/^/    /' "$f"
            done
            echo ""
            echo "### SHA256 Sums"
            for s in proof/sha256sum-*.txt; do
              echo ""
              echo "#### $(basename "$s")"
              sed 's/^/    /' "$s"
            done
          } >> README.md

      - name: "ğŸ§¾ Commit & Push README + ProofLedger"
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md proof ledger || true
          git commit -m "ğŸ“˜ Auto-update README + Heap-Hop Executable ProofLedger" || echo "No changes to commit"
          git push

      - name: "ğŸš€ Create or Update Release"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "heap-hop-v4.1"
          name: "Heap-Hop Edition â€” All is Heap Executable (Go-like Rust Transpiler)"
          body: |
            ğŸ›ï¸ **Go-like-Rust Transpiler â€” All is Heap (v4.1)**  
            âœ… Rust â†’ Go í•´ì„ ê¸°ë°˜ Heap ëª¨ë“œ ì‹¤í–‰íŒŒì¼ ë¦´ë¦¬ì¦ˆ  
            ğŸ¦€ RustSpec ì°¸ì¡° + Heap-Hop Philosophy ë°˜ì˜  
            ğŸ” ProofLedger + SHA256 í•´ì‹œ í¬í•¨  
            âš™ï¸ Everything lives on the heap.  
            **All is heap, heap-hop.**
          files: release-assets/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
